# ç³»ç»Ÿæ¶æ„æ–‡æ¡£ï¼šmermaid-fixer

---

## 1. æ¶æ„æ¦‚è§ˆ (Architecture Overview)

### æ¶æ„è®¾è®¡ç†å¿µ

`mermaid-fixer` æ˜¯ä¸€ä¸ªé¢å‘æŠ€æœ¯æ–‡æ¡£å·¥ç¨‹å¸ˆçš„è½»é‡çº§å‘½ä»¤è¡Œå·¥å…·ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ **â€œé…ç½®é©±åŠ¨ + èŒè´£åˆ†ç¦» + å•å‘ä¾èµ–â€**ï¼Œæ—¨åœ¨ä»¥æä½çš„è¿ç»´æˆæœ¬å®ç° Markdown æ–‡æ¡£ä¸­ Mermaid å›¾è¡¨çš„è‡ªåŠ¨åŒ–éªŒè¯ä¸æ™ºèƒ½ä¿®å¤ã€‚ç³»ç»Ÿéµå¾ª **Rust ç”Ÿæ€çš„é›¶æˆæœ¬æŠ½è±¡åŸåˆ™**ï¼Œé€šè¿‡æ¨¡å—åŒ–è®¾è®¡å®ç°é«˜å†…èšã€ä½è€¦åˆï¼Œç¡®ä¿åœ¨ CI/CD ç¯å¢ƒä¸­ç¨³å®šã€é«˜æ•ˆã€å¯é¢„æµ‹åœ°è¿è¡Œã€‚

ç³»ç»Ÿæ‘’å¼ƒäº†ä¼ ç»Ÿâ€œå¤§è€Œå…¨â€çš„æ¡†æ¶å¼æ¶æ„ï¼Œé‡‡ç”¨ **â€œåŠŸèƒ½å³æ¨¡å—â€** çš„åŸå­åŒ–è®¾è®¡ï¼Œæ¯ä¸ªæ¨¡å—ä»…è´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„èŒè´£ï¼Œé€šè¿‡æ¸…æ™°çš„æ¥å£è¿›è¡Œé€šä¿¡ã€‚è¿™ç§è®¾è®¡ä¸ä»…æå‡äº†ä»£ç çš„å¯æµ‹è¯•æ€§ä¸å¯ç»´æŠ¤æ€§ï¼Œä¹Ÿä½¿ç³»ç»Ÿå¤©ç„¶é€‚é…æ— çŠ¶æ€ã€æ— æ•°æ®åº“ã€çº¯å‘½ä»¤è¡Œçš„éƒ¨ç½²åœºæ™¯ã€‚

### æ ¸å¿ƒæ¶æ„æ¨¡å¼

| æ¨¡å¼ | åº”ç”¨è¯´æ˜ |
|------|----------|
| **åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰** | æ¸…æ™°åˆ’åˆ†ä¸ºï¼šç”¨æˆ·å…¥å£å±‚ï¼ˆCLIï¼‰â†’ é…ç½®ä¸­æ¢å±‚ï¼ˆConfigï¼‰â†’ åè°ƒæ§åˆ¶å±‚ï¼ˆProcessorï¼‰â†’ ä¸šåŠ¡æ‰§è¡Œå±‚ï¼ˆScanner/Validator/AIRepairï¼‰â†’ å·¥å…·æ”¯æŒå±‚ï¼ˆUtilsï¼‰â†’ å¤–éƒ¨ç³»ç»Ÿå±‚ï¼ˆFS/Env/LLMï¼‰ |
| **æ¨¡å—åŒ–æ¶æ„ï¼ˆModular Architectureï¼‰** | æ¯ä¸ªåŠŸèƒ½åŸŸç‹¬ç«‹ä¸ºä¸€ä¸ª Rust æ¨¡å—ï¼ˆ`.rs` æ–‡ä»¶ï¼‰ï¼Œç¼–è¯‘å•å…ƒç‹¬ç«‹ï¼Œé¿å…å¾ªç¯ä¾èµ–ï¼Œæ”¯æŒæŒ‰éœ€æ›¿æ¢ |
| **é…ç½®ä¸­å¿ƒåŒ–ï¼ˆConfiguration-Centricï¼‰** | æ‰€æœ‰è¿è¡Œæ—¶è¡Œä¸ºç”± `config.rs` ç»Ÿä¸€ç®¡ç†ï¼Œå®ç°â€œé…ç½®å³ä»£ç â€ï¼Œæ”¯æŒ CLIã€æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ä¸‰çº§ä¼˜å…ˆçº§åˆå¹¶ |
| **ç®¡é“-è¿‡æ»¤å™¨ï¼ˆPipe-and-Filterï¼‰** | å¤„ç†æµç¨‹ä¸ºçº¿æ€§æµæ°´çº¿ï¼šæ‰«æ â†’ éªŒè¯ â†’ ä¿®å¤ â†’ è¾“å‡ºï¼Œæ¯ä¸ªç¯èŠ‚ä¸ºç‹¬ç«‹â€œè¿‡æ»¤å™¨â€ï¼Œæ•°æ®é€šè¿‡ç»“æ„ä½“ä¼ é€’ |
| **ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰** | `Processor` é€šè¿‡å‚æ•°æ¥æ”¶å…¶ä»–æ¨¡å—å®ä¾‹ï¼Œä¾¿äºå•å…ƒæµ‹è¯•æ—¶ Mockï¼Œç¬¦åˆ Rust çš„â€œæ˜¾å¼ä¾èµ–â€å“²å­¦ |

### æŠ€æœ¯æ ˆæ¦‚è¿°

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | é€‰å‹ç†ç”± |
|------|----------|----------|
| **è¯­è¨€** | Rust 1.70+ | å†…å­˜å®‰å…¨ã€é›¶æˆæœ¬æŠ½è±¡ã€ç¼–è¯‘æœŸæ£€æŸ¥ã€æ—  GCã€é€‚åˆ CLI å·¥å…· |
| **CLI è§£æ** | `clap` (v4) | åŠŸèƒ½å®Œå¤‡ã€ç±»å‹å®‰å…¨ã€è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©æ–‡æ¡£ã€æ”¯æŒå­å‘½ä»¤æ‰©å±• |
| **é…ç½®ç®¡ç†** | `serde` + `toml` | åºåˆ—åŒ–/ååºåˆ—åŒ–æ ‡å‡†åŒ–ï¼ŒTOML äººç±»å¯è¯»ï¼Œé€‚åˆé…ç½®æ–‡ä»¶ |
| **Mermaid è§£æ** | `mermaid-rs` | å®˜æ–¹ Rust å®ç°ï¼Œè¯­æ³•è§£æå‡†ç¡®ï¼Œé”™è¯¯ä¿¡æ¯ç»“æ„åŒ– |
| **HTTP å®¢æˆ·ç«¯** | `reqwest` (async) | æ”¯æŒå¼‚æ­¥ã€TLSã€è¶…æ—¶ã€é‡è¯•ï¼Œç”Ÿæ€æˆç†Ÿ |
| **JSON å¤„ç†** | `serde_json` | ä¸ `serde` æ— ç¼é›†æˆï¼Œç”¨äºè§£æ LLM API å“åº” |
| **æ–‡ä»¶ç³»ç»Ÿ** | `std::fs` + `walkdir` | æ ‡å‡†åº“ + é«˜æ•ˆé€’å½’éå†ï¼Œæ— å¤–éƒ¨ä¾èµ– |
| **æ—¥å¿—è¾“å‡º** | `std::println!` + `utils.rs` | ç®€æ´å¯æ§ï¼Œé¿å…æ—¥å¿—åº“å¼•å…¥å¤æ‚æ€§ï¼Œä¾¿äº CI è§£æ |
| **æµ‹è¯•æ¡†æ¶** | `#[cfg(test)]` + `mockall`ï¼ˆå¯é€‰ï¼‰ | åŸç”Ÿæ”¯æŒï¼Œæ¨¡å—å¯ç‹¬ç«‹ Mockï¼Œé›†æˆæµ‹è¯•æˆæœ¬ä½ |

> âœ… **æŠ€æœ¯é€‰å‹æ´å¯Ÿ**ï¼šæ‰€æœ‰ä¾èµ–å‡ä¸º **çº¯ Rustã€æ— è¿è¡Œæ—¶å¼€é”€ã€æ— åŠ¨æ€é“¾æ¥**ï¼Œç¡®ä¿æœ€ç»ˆäºŒè¿›åˆ¶ä½“ç§¯å°ï¼ˆ<10MBï¼‰ã€å¯åŠ¨å¿«ï¼ˆ<100msï¼‰ã€è·¨å¹³å°ï¼ˆWindows/macOS/Linuxï¼‰å…¼å®¹ï¼Œå®Œç¾å¥‘åˆ CI/CD é›†æˆéœ€æ±‚ã€‚

---

## 2. ç³»ç»Ÿä¸Šä¸‹æ–‡ (System Context)

### ç³»ç»Ÿå®šä½ä¸ä»·å€¼

`mermaid-fixer` æ˜¯ä¸€ä¸ª**è‡ªåŠ¨åŒ–æ–‡æ¡£è´¨é‡ä¿éšœå·¥å…·**ï¼Œä¸“ä¸ºæŠ€æœ¯å›¢é˜Ÿè§£å†³â€œMermaid å›¾è¡¨è¯­æ³•é”™è¯¯é¢‘å‘ã€äººå·¥å®¡æŸ¥æˆæœ¬é«˜â€çš„ç—›ç‚¹è€Œè®¾è®¡ã€‚å…¶æ ¸å¿ƒä»·å€¼åœ¨äºï¼š

- **é™ä½äººå·¥æˆæœ¬**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶ä¿®å¤ 80%+ çš„å¸¸è§è¯­æ³•é”™è¯¯ï¼ˆå¦‚æ‹¬å·ä¸åŒ¹é…ã€å…³é”®å­—æ‹¼å†™é”™è¯¯ã€ç¼©è¿›é”™è¯¯ï¼‰ã€‚
- **æå‡ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰æ–‡æ¡£ä¸­çš„å›¾è¡¨ç¬¦åˆå›¢é˜Ÿè§„èŒƒï¼Œé¿å…å› æ ¼å¼æ··ä¹±å¯¼è‡´çš„æ²Ÿé€šè¯¯è§£ã€‚
- **èµ‹èƒ½ CI/CD**ï¼šå¯ä½œä¸º Git Hook æˆ– GitHub Actions æ­¥éª¤ï¼Œå®ç°â€œæ–‡æ¡£å³ä»£ç â€çš„è´¨é‡é—¨ç¦ã€‚
- **å¼€ç®±å³ç”¨**ï¼šé¦–æ¬¡è¿è¡Œè‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å³å¯ä½¿ç”¨ã€‚

é€‚ç”¨äºæ‹¥æœ‰æ•°ç™¾ä¸ª Markdown æ–‡æ¡£çš„ä¸­å¤§å‹æŠ€æœ¯å›¢é˜Ÿï¼Œå¦‚å¼€æºé¡¹ç›®ã€æŠ€æœ¯åšå®¢å¹³å°ã€ä¼ä¸šå†…éƒ¨çŸ¥è¯†åº“ç­‰ã€‚

### ç”¨æˆ·è§’è‰²ä¸åœºæ™¯

| ç”¨æˆ·è§’è‰² | ä½¿ç”¨åœºæ™¯ | æ ¸å¿ƒéœ€æ±‚ |
|----------|----------|----------|
| **æŠ€æœ¯æ–‡æ¡£å·¥ç¨‹å¸ˆ** | æ¯æ—¥ç»´æŠ¤æ¶æ„å›¾ã€æµç¨‹å›¾æ–‡æ¡£ | æ‰¹é‡å¤„ç†ã€å¿«é€Ÿåé¦ˆã€ä¿®å¤å»ºè®®æ¸…æ™°ã€æ”¯æŒè‡ªå®šä¹‰æ¨¡å‹ |
| **å¼€å‘è€…** | åœ¨ PR ä¸­æäº¤æ–‡æ¡£å˜æ›´ | æœ¬åœ°é¢„æ£€ã€CI è‡ªåŠ¨æ‹¦æˆªé”™è¯¯ã€ä¸æ‰“æ–­å¼€å‘æµ |
| **DevOps å·¥ç¨‹å¸ˆ** | é…ç½® CI/CD æµæ°´çº¿ | æ— ä¾èµ–ã€è½»é‡ã€è¾“å‡ºç»“æ„åŒ– JSON/æ–‡æœ¬ã€å¤±è´¥å³ä¸­æ–­æ„å»º |

> ğŸ“Œ **å…¸å‹åœºæ™¯**ï¼šå¼€å‘è€…åœ¨ PR ä¸­ä¿®æ”¹äº† `architecture.md`ï¼ŒCI æµæ°´çº¿æ‰§è¡Œ `mermaid-fixer --path docs --fail-on-error`ï¼Œè‹¥å‘ç° 3 ä¸ªæ— æ•ˆå›¾è¡¨ï¼Œåˆ™è‡ªåŠ¨å¤±è´¥å¹¶è¾“å‡ºä¿®å¤å»ºè®®ï¼Œé˜»æ­¢åˆå¹¶ã€‚

### å¤–éƒ¨ç³»ç»Ÿäº¤äº’

| å¤–éƒ¨ç³»ç»Ÿ | äº¤äº’æ–¹å¼ | æ•°æ®æµå‘ | å®‰å…¨æ€§è€ƒé‡ |
|----------|----------|----------|------------|
| **LLM APIï¼ˆå¦‚ Mistralã€OpenAIï¼‰** | HTTPS POSTï¼ˆJSONï¼‰ | è¯·æ±‚ï¼š`{"prompt": "ä¿®å¤æ­¤ Mermaid ä»£ç ...", "model": "mistral"}`<br>å“åº”ï¼š`{"fixed_code": "graph TD\n    A-->B"}` | API å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼Œ**ç»ä¸å†™å…¥é…ç½®æ–‡ä»¶**ï¼›è¯·æ±‚è¶…æ—¶ 10sï¼Œå¤±è´¥è‡ªåŠ¨é‡è¯• 2 æ¬¡ |
| **æ–‡ä»¶ç³»ç»Ÿ** | æ–‡ä»¶è¯»å†™ï¼ˆ`.md`, `.toml`ï¼‰ | è¯»å–ï¼šMarkdown æ–‡ä»¶ã€config.toml<br>å†™å…¥ï¼šä¿®å¤åæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ã€é¦–æ¬¡ç”Ÿæˆ config.toml | ä»…æ“ä½œæŒ‡å®šç›®å½•ï¼Œæ— æƒé™æå‡ï¼›å†™å…¥å‰å¤‡ä»½ï¼ˆå¯æ‰©å±•ï¼‰ |
| **ç¯å¢ƒå˜é‡** | ç¯å¢ƒå˜é‡è¯»å– | `MERMAID_FIXER_API_KEY`, `MERMAID_FIXER_MODEL`, `MERMAID_FIXER_BASE_URL` | æ•æ„Ÿä¿¡æ¯ä¸ç¡¬ç¼–ç ï¼Œç¬¦åˆ 12-Factor App åŸåˆ™ |

### ç³»ç»Ÿè¾¹ç•Œå®šä¹‰

| åŒ…å«ç»„ä»¶ | ä¸åŒ…å«ç»„ä»¶ |
|----------|------------|
| âœ… CLI å‚æ•°è§£æå™¨ï¼ˆ`cli.rs`ï¼‰ | âŒ Mermaid æ¸²æŸ“å¼•æ“ï¼ˆä»…é€šè¿‡ `mermaid-rs` é—´æ¥è°ƒç”¨ï¼‰ |
| âœ… é…ç½®åŠ è½½å™¨ï¼ˆ`config.rs`ï¼‰ | âŒ Web UI / å›¾å½¢ç•Œé¢ |
| âœ… Markdown æ–‡ä»¶æ‰«æå™¨ï¼ˆ`markdown_scanner.rs`ï¼‰ | âŒ æ•°æ®åº“ / æŒä¹…åŒ–å­˜å‚¨ |
| âœ… Mermaid è¯­æ³•éªŒè¯å™¨ï¼ˆ`mermaid_validator.rs`ï¼‰ | âŒ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ |
| âœ… AI ä¿®å¤ä»£ç†ï¼ˆ`ai_fixer.rs`ï¼‰ | âŒ ç½‘ç»œæœåŠ¡ç«¯ç‚¹ï¼ˆæ—  HTTP æœåŠ¡å™¨ï¼‰ |
| âœ… å¤„ç†åè°ƒå™¨ï¼ˆ`processor.rs`ï¼‰ | âŒ å®æ—¶åä½œ / å¤šäººç¼–è¾‘åŠŸèƒ½ |
| âœ… å·¥å…·æ”¯æŒæ¨¡å—ï¼ˆ`utils.rs`ï¼‰ | âŒ è‡ªåŠ¨æ¨é€ä¿®å¤åˆ° Git |

> ğŸ”’ **è¾¹ç•Œè®¾è®¡åŸåˆ™**ï¼šç³»ç»Ÿæ˜¯**çº¯å®¢æˆ·ç«¯å·¥å…·**ï¼Œä¸æ‰˜ç®¡ä»»ä½•æ•°æ®ï¼Œä¸æš´éœ²ä»»ä½•æœåŠ¡ï¼Œæ‰€æœ‰æ“ä½œåœ¨æœ¬åœ°å®Œæˆï¼Œä»…åœ¨å¿…è¦æ—¶å‘èµ·å•å‘ HTTP è¯·æ±‚ã€‚è¿™æå¤§é™ä½äº†å®‰å…¨é£é™©ä¸è¿ç»´å¤æ‚åº¦ã€‚

---

## 3. å®¹å™¨è§†å›¾ (Container View)

### é¢†åŸŸæ¨¡å—åˆ’åˆ†

ç³»ç»Ÿç”± **7 ä¸ªæ ¸å¿ƒå®¹å™¨ï¼ˆContainerï¼‰** æ„æˆï¼Œæ¯ä¸ªå®¹å™¨å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ Rust æ¨¡å—ï¼Œå…·æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œï¼š

| å®¹å™¨åç§° | ç±»å‹ | ä½ç½® | èŒè´£ç®€è¿° |
|----------|------|------|----------|
| **CLIå…¥å£åŸŸ** | ç”¨æˆ·å…¥å£ | `src/cli.rs` | è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œæ˜ å°„ä¸ºé…ç½®å¯¹è±¡ï¼Œå¯åŠ¨ä¸»æµç¨‹ |
| **é…ç½®ç®¡ç†åŸŸ** | é…ç½®ä¸­æ¢ | `src/config.rs` | åˆå¹¶ CLIã€config.tomlã€ç¯å¢ƒå˜é‡ï¼Œè¾“å‡ºç»“æ„åŒ–é…ç½® |
| **å¤„ç†åè°ƒåŸŸ** | æ§åˆ¶ä¸­å¿ƒ | `src/processor.rs` | åè°ƒæ‰«æã€éªŒè¯ã€ä¿®å¤æµç¨‹ï¼Œæ§åˆ¶å†™å›ç­–ç•¥ï¼Œæ±‡æ€»ç»“æœ |
| **æ–‡ä»¶æ‰«æåŸŸ** | ä¸šåŠ¡æ‰§è¡Œ | `src/markdown_scanner.rs` | é€’å½’æ‰«æç›®å½•ï¼Œæ”¶é›†æ‰€æœ‰ `.md` / `.markdown` æ–‡ä»¶ |
| **è¯­æ³•éªŒè¯åŸŸ** | ä¸šåŠ¡æ‰§è¡Œ | `src/mermaid_validator.rs` | ä½¿ç”¨ `mermaid-rs` è§£æå›¾è¡¨ï¼Œåˆ†ç±»è¯­æ³•é”™è¯¯ç±»å‹ |
| **AIä¿®å¤åŸŸ** | ä¸šåŠ¡æ‰§è¡Œ | `src/ai_fixer.rs` | è°ƒç”¨è¿œç¨‹ LLM APIï¼Œæ„å»º Promptï¼Œè§£æä¿®å¤ç»“æœ |
| **å·¥å…·æ”¯æŒåŸŸ** | å·¥å…·æ”¯æŒ | `src/utils.rs` | æä¾›çº¯å‡½æ•°å·¥å…·ï¼šæå–ä»£ç å—ã€æ ¼å¼åŒ–è¾“å‡ºã€é”™è¯¯ç¼–ç  |

### é¢†åŸŸæ¨¡å—æ¶æ„

```mermaid
graph TD
    %% ==================== å®¹å™¨è§†å›¾ï¼šmermaid-fixer ====================
    subgraph "ç”¨æˆ·å…¥å£"
        CLI[CLIå…¥å£åŸŸ]
    end

    subgraph "é…ç½®ä¸­æ¢"
        Config[é…ç½®ç®¡ç†åŸŸ]
    end

    subgraph "å¤„ç†åè°ƒä¸­å¿ƒ"
        Processor[å¤„ç†åè°ƒåŸŸ]
    end

    subgraph "æ ¸å¿ƒä¸šåŠ¡æ¨¡å—"
        Scanner[æ–‡ä»¶æ‰«æåŸŸ]
        Validator[è¯­æ³•éªŒè¯åŸŸ]
        AIRepair[AIä¿®å¤åŸŸ]
    end

    subgraph "å·¥å…·æ”¯æŒå±‚"
        Utils[å·¥å…·æ”¯æŒåŸŸ]
    end

    subgraph "å¤–éƒ¨ç³»ç»Ÿ"
        FS[æ–‡ä»¶ç³»ç»Ÿ]
        Env[ç¯å¢ƒå˜é‡]
        LLM[LLMè¿œç¨‹æœåŠ¡]
    end

    %% ==================== äº¤äº’å…³ç³» ====================

    %% ç”¨æˆ·å…¥å£ â†’ é…ç½®ä¸­æ¢
    CLI -->|"è§£æå‚æ•°ç”Ÿæˆé…ç½®"| Config

    %% é…ç½®ä¸­æ¢ â†’ æ‰€æœ‰æ ¸å¿ƒæ¨¡å—ï¼ˆé…ç½®ä¾èµ–ï¼‰
    Config -->|"æä¾›è·¯å¾„æ’é™¤è§„åˆ™"| Scanner
    Config -->|"æä¾›è¶…æ—¶éªŒè¯è§„åˆ™"| Validator
    Config -->|"æä¾›APIå¯†é’¥æ¨¡å‹URL"| AIRepair
    Config -->|"æä¾›æ˜¯å¦å†™å›ä¿®å¤å¼€å…³"| Processor

    %% ç”¨æˆ·å…¥å£ â†’ å¤„ç†åè°ƒä¸­å¿ƒ
    CLI -->|"è°ƒç”¨main_process"| Processor

    %% å¤„ç†åè°ƒä¸­å¿ƒ â†’ æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼ˆæœåŠ¡è°ƒç”¨ï¼‰
    Processor -->|"è°ƒç”¨æ‰«æ"| Scanner
    Processor -->|"é€æ–‡ä»¶è°ƒç”¨éªŒè¯"| Validator
    Processor -->|"è°ƒç”¨AIä¿®å¤"| AIRepair
    Processor -->|"è°ƒç”¨è¾“å‡º"| Utils

    %% æ ¸å¿ƒæ¨¡å— â†’ å·¥å…·æ”¯æŒå±‚ï¼ˆè¾…åŠ©è°ƒç”¨ï¼‰
    Scanner -->|"æå–ä»£ç å—"| Utils
    AIRepair -->|"æ„å»ºè¯·æ±‚"| Config
    Validator -->|"è¯»å–è¶…æ—¶"| Config

    %% å¤„ç†åè°ƒä¸­å¿ƒ â†’ å¤–éƒ¨ç³»ç»Ÿï¼ˆIOï¼‰
    Processor -->|"è¯»å†™æ–‡ä»¶"| FS
    AIRepair -->|"HTTPè¯·æ±‚"| LLM
    Config -->|"è¯»å–ç¯å¢ƒå˜é‡"| Env

    %% å¯é€‰ï¼šé…ç½®åˆå§‹åŒ–æµç¨‹ï¼ˆéä¸»æµç¨‹ï¼‰
    style Config fill:#d4edda,stroke:#28a745
    
    %% æ ·å¼å®šä¹‰
    classDef entry fill:#cce5ff,stroke:#007bff;
    classDef config fill:#d4edda,stroke:#28a745;
    classDef processor fill:#fff3cd,stroke:#ffc107;
    classDef coreBusiness fill:#e2e3e5,stroke:#6c757d;
    classDef tool fill:#f8d7da,stroke:#dc3545;
    classDef external fill:#e9ecef,stroke:#adb5bd;

    class CLI entry
    class Config config
    class Processor processor
    class Scanner,Validator,AIRepair coreBusiness
    class Utils tool
    class FS,Env,LLM external
```

### å­˜å‚¨è®¾è®¡

| å­˜å‚¨ç±»å‹ | æ ¼å¼ | ç”¨é€” | æŒä¹…æ€§ | ç®¡ç†æ–¹å¼ |
|----------|------|------|--------|----------|
| **é…ç½®æ–‡ä»¶** | TOML | å­˜å‚¨ LLM API å¯†é’¥ã€æ¨¡å‹åã€è¶…æ—¶ã€æ’é™¤è·¯å¾„ç­‰ | æŒä¹…åŒ– | ç”± `config.rs` ç”Ÿæˆï¼Œç”¨æˆ·å¯æ‰‹åŠ¨ç¼–è¾‘ |
| **Markdown æ–‡ä»¶** | `.md` / `.markdown` | å­˜å‚¨å¾…ä¿®å¤çš„ Mermaid å›¾è¡¨ | æŒä¹…åŒ– | ç”± `Scanner` è¯»å–ï¼Œ`Processor` å¯é€‰å†™å› |
| **å†…å­˜ç¼“å­˜** | `Vec<FileInfo>` / `HashMap<CodeBlockId, ValidationResult>` | å­˜å‚¨æ‰«æç»“æœã€éªŒè¯çŠ¶æ€ã€ä¿®å¤å»ºè®® | ä¸´æ—¶ | è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸå†…æœ‰æ•ˆï¼Œæ— åºåˆ—åŒ– |

> ğŸ’¡ **è®¾è®¡æ´å¯Ÿ**ï¼šç³»ç»Ÿ**æ— æ•°æ®åº“ã€æ— ç¼“å­˜å±‚ã€æ— çŠ¶æ€**ï¼Œæ‰€æœ‰çŠ¶æ€å‡åœ¨å†…å­˜ä¸­å¤„ç†ï¼Œè¿›ç¨‹é€€å‡ºå³æ¸…ç©ºã€‚è¿™æå¤§ç®€åŒ–äº†éƒ¨ç½²ä¸æ•…éšœæ¢å¤ã€‚

### é¢†åŸŸæ¨¡å—é—´é€šä¿¡

| é€šä¿¡æ–¹å¼ | è¯´æ˜ |
|----------|------|
| **ç»“æ„ä½“ä¼ é€’** | æ‰€æœ‰æ¨¡å—é—´é€šè¿‡ `struct` ä¼ é€’æ•°æ®ï¼ˆå¦‚ `Config`, `FileScanResult`, `ValidationResult`ï¼‰ï¼Œç±»å‹å®‰å…¨ï¼Œæ— åå°„ |
| **å‡½æ•°è°ƒç”¨** | `Processor` é€šè¿‡ç›´æ¥å‡½æ•°è°ƒç”¨ï¼ˆ`scanner.scan()`ï¼‰è§¦å‘æ¨¡å—ï¼Œéäº‹ä»¶é©±åŠ¨ï¼Œæµç¨‹æ¸…æ™° |
| **ä¾èµ–æ³¨å…¥** | `Processor` æ¥æ”¶ `Scanner`, `Validator`, `AIRepair` çš„å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œä¾¿äºæµ‹è¯•æ—¶ Mock |
| **é…ç½®å…±äº«** | æ‰€æœ‰æ¨¡å—é€šè¿‡ `Arc<Config>` å…±äº«åªè¯»é…ç½®ï¼Œé¿å…é‡å¤åŠ è½½ |
| **é”™è¯¯æšä¸¾** | æ¯ä¸ªæ¨¡å—å®šä¹‰è‡ªå·±çš„ `Error` æšä¸¾ï¼ˆå¦‚ `ValidationError::InvalidSyntax`, `AIError::Timeout`ï¼‰ï¼Œç»Ÿä¸€é€šè¿‡ `Result<T, Error>` è¿”å› |

> âœ… **é€šä¿¡åŸåˆ™**ï¼š**å•å‘ã€æ˜¾å¼ã€æ— å›è°ƒã€æ— å…¨å±€çŠ¶æ€**ï¼Œç¬¦åˆ Rust çš„â€œæ˜¾å¼ä¼˜äºéšå¼â€å“²å­¦ã€‚

---

## 4. ç»„ä»¶è§†å›¾ (Component View)

### æ ¸å¿ƒåŠŸèƒ½ç»„ä»¶

#### 1. **é…ç½®ç®¡ç†åŸŸï¼ˆ`config.rs`ï¼‰**

- **èŒè´£**ï¼šé…ç½®çš„åŠ è½½ã€åˆå¹¶ã€éªŒè¯ã€åºåˆ—åŒ–
- **å…³é”®ç»“æ„**ï¼š
  ```rust
  #[derive(Serialize, Deserialize, Clone)]
  pub struct Config {
      pub path: String,
      pub exclude: Vec<String>,
      pub api_key: String,
      pub model: String,
      pub base_url: String,
      pub timeout_ms: u64,
      pub dry_run: bool,
      pub write_back: bool,
  }
  ```
- **å®ç°ç»†èŠ‚**ï¼š
  - ä¸‰çº§ä¼˜å…ˆçº§ï¼š**ç¯å¢ƒå˜é‡ > CLI å‚æ•° > config.toml**
  - ä½¿ç”¨ `serde` ååºåˆ—åŒ– TOMLï¼Œæ”¯æŒé»˜è®¤å€¼ï¼ˆ`#[serde(default)]`ï¼‰
  - é¦–æ¬¡è¿è¡Œæ—¶ï¼Œä» `include_str!()` åŠ è½½å†…ç½®æ¨¡æ¿ï¼Œå†™å…¥ `./config.toml`
- **æ‰©å±•ç‚¹**ï¼šå¯æ‰©å±•ä¸ºæ”¯æŒ JSON/YAMLï¼Œé€šè¿‡ `ConfigFormat` æšä¸¾åˆ‡æ¢

#### 2. **è¯­æ³•éªŒè¯åŸŸï¼ˆ`mermaid_validator.rs`ï¼‰**

- **èŒè´£**ï¼šè§£æ Mermaid ä»£ç å—ï¼Œè¿”å›ç»“æ„åŒ–é”™è¯¯
- **å…³é”®ç»“æ„**ï¼š
  ```rust
  #[derive(Debug, Clone, PartialEq)]
  pub enum ValidationError {
      MissingClosingBrace,
      InvalidKeyword(String),
      SyntaxError(String), // åŸå§‹é”™è¯¯ä¿¡æ¯
      EmptyBlock,
  }
  ```
- **å®ç°ç»†èŠ‚**ï¼š
  - ä½¿ç”¨ `mermaid-rs` çš„ `parse_diagram()` æ–¹æ³•
  - æ•è·åº•å±‚é”™è¯¯ï¼Œæ˜ å°„ä¸ºä¸šåŠ¡å‹å¥½çš„æšä¸¾
  - æ”¯æŒå¤šå›¾å—å¹¶è¡ŒéªŒè¯ï¼ˆ`rayon` å¹¶è¡Œè¿­ä»£ï¼‰
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ `Cow<str>` é¿å…å­—ç¬¦ä¸²æ‹·è´ï¼Œå‡å°‘å†…å­˜åˆ†é…

#### 3. **AIä¿®å¤åŸŸï¼ˆ`ai_fixer.rs`ï¼‰**

- **èŒè´£**ï¼šæ„å»º Promptï¼Œè°ƒç”¨ LLMï¼Œè§£æä¿®å¤ç»“æœ
- **å…³é”®ç»“æ„**ï¼š
  ```rust
  pub struct AiFixer {
      client: reqwest::Client,
      config: Arc<Config>,
  }
  ```
- **å®ç°ç»†èŠ‚**ï¼š
  - Prompt æ¨¡æ¿ï¼š
    ```
    ä½ æ˜¯ä¸€ä¸ª Mermaid ä¸“å®¶ã€‚è¯·ä¿®å¤ä»¥ä¸‹æœ‰è¯­æ³•é”™è¯¯çš„ Mermaid å›¾è¡¨ï¼Œä»…è¿”å›ä¿®å¤åçš„ä»£ç ï¼Œä¸è¦è§£é‡Šã€‚
    ```mermaid
graph TD
    A[è®¿é—®çŸ­é“¾æ¥] --> B{åœ¨Redisä¸­æŸ¥è¯¢}
    B -- "æœªå‘½ä¸­" --> C[ä»æ•°æ®åº“æŸ¥è¯¢]
    C --> D{æŸ¥è¯¢ç»“æœ}
    D -- "æœ‰ç»“æœ" --> E[è·å–åŸå§‹é“¾æ¥]
    D -- "æ— ç»“æœ" --> F[è¿”å›é”™è¯¯ä¿¡æ¯]
    E --> G[è·å–æˆåŠŸ]
    F --> H[è¿”å›é”™è¯¯é¡µé¢]
    B -- "å‘½ä¸­" --> E
    G --> I[302é‡å®šå‘]
    I --> J[ç»“æŸ]
    ```
    ```
  - ä½¿ç”¨ `reqwest::Client` å¼‚æ­¥è¯·æ±‚ï¼Œè®¾ç½®è¶…æ—¶ã€é‡è¯•ï¼ˆ2 æ¬¡ï¼‰ã€User-Agent
  - å“åº”è§£æï¼šä½¿ç”¨ `serde_json::from_str::<AiResponse>`ï¼Œæå– `fixed_code`
  - å®¹é”™ï¼šè‹¥ LLM è¿”å›éä»£ç å†…å®¹ï¼Œè¿”å›åŸå§‹å—å¹¶è®°å½•è­¦å‘Š
- **æ‰©å±•ç‚¹**ï¼šæ”¯æŒå¤šæ¨¡å‹ï¼ˆOpenAIã€Claudeã€æœ¬åœ° Ollamaï¼‰ï¼Œé€šè¿‡ `model` å­—æ®µåˆ‡æ¢

#### 4. **å¤„ç†åè°ƒåŸŸï¼ˆ`processor.rs`ï¼‰**

- **èŒè´£**ï¼šæµç¨‹ç¼–æ’ã€ç­–ç•¥æ§åˆ¶ã€ç»“æœæ±‡æ€»
- **å…³é”®æ–¹æ³•**ï¼š
  ```rust
  pub fn process(&self, config: &Config) -> Result<ProcessSummary, Error> {
      let files = self.scanner.scan(&config.path, &config.exclude)?;
      let mut summary = ProcessSummary::new();
      
      for file in files {
          let blocks = self.utils.extract_mermaid_blocks(&file.content)?;
          for block in blocks {
              match self.validator.validate(&block.code) {
                  Ok(_) => summary.successful += 1,
                  Err(e) => {
                      summary.failed += 1;
                      if config.write_back && !config.dry_run {
                          if let Some(fixed) = self.ai_fixer.fix(&block.code, &config).await? {
                              self.utils.write_back(&file.path, &block, &fixed)?;
                          }
                      }
                  }
              }
          }
      }
      self.utils.print_statistics(&summary);
      Ok(summary)
  }
  ```
- **è®¾è®¡äº®ç‚¹**ï¼š
  - **æ— çŠ¶æ€**ï¼šä¸ä¿å­˜ä¸­é—´çŠ¶æ€ï¼Œæ‰€æœ‰é€»è¾‘åŸºäºè¾“å…¥å’Œé…ç½®
  - **ç­–ç•¥é©±åŠ¨**ï¼š`dry_run`ã€`write_back` æ§åˆ¶è¡Œä¸ºï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
  - **åŸå­æ€§**ï¼šæ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹å¤„ç†ï¼Œä¸€ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–

### æŠ€æœ¯æ”¯æ’‘ç»„ä»¶

#### 1. **CLIå…¥å£åŸŸï¼ˆ`cli.rs`ï¼‰**

- ä½¿ç”¨ `clap` å®šä¹‰å‘½ä»¤è¡Œï¼š
  ```rust
  #[derive(Parser)]
  pub struct Cli {
      #[arg(short, long, value_name = "DIR")]
      pub path: String,

      #[arg(long, default_value_t = false)]
      pub dry_run: bool,

      #[arg(long, default_value_t = false)]
      pub write_back: bool,

      #[arg(long, default_value_t = false)]
      pub fail_on_error: bool,
  }
  ```
- **æ ¸å¿ƒä»·å€¼**ï¼šå°† CLI å‚æ•°æ˜ å°„ä¸º `Config`ï¼Œå®ç°â€œç”¨æˆ·è¾“å…¥ â†’ ç³»ç»Ÿè¡Œä¸ºâ€çš„ç²¾å‡†è½¬æ¢

#### 2. **å·¥å…·æ”¯æŒåŸŸï¼ˆ`utils.rs`ï¼‰**

- **çº¯å‡½æ•°å·¥å…·é›†**ï¼š
  ```rust
  pub fn extract_mermaid_blocks(content: &str) -> Vec<CodeBlock> { ... }
  pub fn print_statistics(summary: &ProcessSummary) { ... }
  pub fn write_back(file_path: &Path, block: &CodeBlock, fixed: &str) -> Result<(), io::Error> { ... }
  ```
- **è®¾è®¡åŸåˆ™**ï¼š**æ— å‰¯ä½œç”¨ã€æ— ä¾èµ–ã€å¯æµ‹è¯•**ï¼Œæ‰€æœ‰å‡½æ•°å‡ä¸º `pub fn`ï¼Œå¯è¢«å¤–éƒ¨å¤ç”¨

### ç»„ä»¶äº¤äº’å…³ç³»

```mermaid
graph LR
    CLI --> Config
    Config --> Scanner
    Config --> Validator
    Config --> AIRepair
    Config --> Processor
    CLI --> Processor
    Processor --> Scanner
    Processor --> Validator
    Processor --> AIRepair
    Processor --> Utils
    Scanner --> Utils
    AIRepair --> Config
    Validator --> Config
    Processor --> FS
    AIRepair --> LLM

    style CLI fill:#cce5ff,stroke:#007bff
    style Config fill:#d4edda,stroke:#28a745
    style Processor fill:#fff3cd,stroke:#ffc107
    style Scanner,Validator,AIRepair fill:#e2e3e5,stroke:#6c757d
    style Utils fill:#f8d7da,stroke:#dc3545
    style FS,LLM fill:#e9ecef,stroke:#adb5bd
```

> ğŸ” **äº¤äº’æ´å¯Ÿ**ï¼šæ‰€æœ‰æ¨¡å—ä»…ä¾èµ–å…¶â€œä¸Šæ¸¸â€æˆ–â€œé…ç½®â€ï¼Œ**æ— å¾ªç¯ä¾èµ–**ã€‚è¿™æ˜¯ç³»ç»Ÿå¯ç»´æŠ¤æ€§çš„åŸºçŸ³ã€‚

---

## 5. å…³é”®æµç¨‹ (Key Processes)

### æ ¸å¿ƒåŠŸèƒ½æµç¨‹ï¼šMermaid æ–‡æ¡£æ‰¹é‡ä¿®å¤æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æ‰§è¡Œå‘½ä»¤: mermaid-fixer --path <dir>] --> B[CLIå…¥å£åŸŸè§£æå‚æ•°]
    B --> C[é…ç½®ç®¡ç†åŸŸåŠ è½½å¹¶åˆå¹¶é…ç½®ï¼ˆCLI/æ–‡ä»¶/ç¯å¢ƒå˜é‡ï¼‰]
    C --> D[å¤„ç†åè°ƒåŸŸå¯åŠ¨ä¸»æµç¨‹]
    D --> E[æ–‡ä»¶æ‰«æåŸŸé€’å½’æ‰«æç›®å½•ï¼Œæ”¶é›†æ‰€æœ‰.md/.markdownæ–‡ä»¶]
    E --> F[å¯¹æ¯ä¸ªæ–‡ä»¶ï¼šæå–Mermaidä»£ç å—]
    F --> G[è¯­æ³•éªŒè¯åŸŸéªŒè¯æ¯ä¸ªä»£ç å—è¯­æ³•æœ‰æ•ˆæ€§]
    G --> H{æ˜¯å¦æœ‰æ•ˆï¼Ÿ}
    H -- æ˜¯ --> I[è·³è¿‡ï¼Œè®°å½•æˆåŠŸ]
    H -- å¦ --> J[AIä¿®å¤åŸŸè°ƒç”¨LLM APIè¯·æ±‚ä¿®å¤]
    J --> K[å¤„ç†åè°ƒåŸŸåˆ¤æ–­æ˜¯å¦å¯ç”¨å†™å›]
    K -- æ˜¯ --> L[å°†ä¿®å¤åä»£ç å†™å›åŸæ–‡ä»¶]
    K -- å¦ --> M[ä»…è®°å½•ä¿®å¤å»ºè®®]
    I --> N[æ±‡æ€»æ‰€æœ‰å¤„ç†ç»“æœ]
    M --> N
    L --> N
    N --> O[å·¥å…·æ”¯æŒåŸŸè¾“å‡ºç»Ÿè®¡æŠ¥å‘Š]
    O --> P[æµç¨‹ç»“æŸ]

    style A fill:#cce5ff,stroke:#007bff
    style C fill:#d4edda,stroke:#28a745
    style D fill:#fff3cd,stroke:#ffc107
    style E fill:#e2e3e5,stroke:#6c757d
    style G fill:#e2e3e5,stroke:#6c757d
    style J fill:#e2e3e5,stroke:#6c757d
    style L,M fill:#e2e3e5,stroke:#6c757d
    style O fill:#f8d7da,stroke:#dc3545
```

### æŠ€æœ¯å¤„ç†æµç¨‹ï¼šAIä¿®å¤è¯·æ±‚æµç¨‹

```mermaid
graph LR
    A[AIä¿®å¤åŸŸæ”¶åˆ°æ— æ•ˆä»£ç å—] --> B[æ„å»ºPromptæ¨¡æ¿]
    B --> C[ä»Configè¯»å–APIå¯†é’¥ã€æ¨¡å‹ã€URL]
    C --> D[æ„é€ HTTPè¯·æ±‚ï¼šPOST /v1/completions]
    D --> E[è®¾ç½®Header: Authorization, Content-Type]
    E --> F[å‘é€å¼‚æ­¥è¯·æ±‚ï¼Œè¶…æ—¶10s]
    F --> G{å“åº”æˆåŠŸï¼Ÿ}
    G -- æ˜¯ --> H[è§£æJSONï¼Œæå–fixed_code]
    H --> I[éªŒè¯è¿”å›å†…å®¹æ˜¯å¦ä¸ºåˆæ³•Mermaid]
    I --> J[è¿”å›ä¿®å¤åä»£ç ]
    G -- å¦ --> K[è®°å½•é”™è¯¯ï¼šTimeout/401/InvalidResponse]
    K --> L[è¿”å›åŸå§‹ä»£ç ï¼Œæ ‡è®°ä¸ºâ€œä¿®å¤å¤±è´¥â€]
    J --> M[è¿”å›ç»™å¤„ç†åè°ƒåŸŸ]
    L --> M

    style A fill:#e2e3e5,stroke:#6c757d
    style C fill:#d4edda,stroke:#28a745
    style F fill:#e9ecef,stroke:#adb5bd
    style H fill:#e2e3e5,stroke:#6c757d
    style I fill:#e2e3e5,stroke:#6c757d
    style K fill:#f8d7da,stroke:#dc3545
```

### æ•°æ®æµè½¬è·¯å¾„

| é˜¶æ®µ | æ•°æ®å¯¹è±¡ | ä¼ é€’æ–¹å‘ | æ ¼å¼ |
|------|----------|----------|------|
| 1. è¾“å…¥ | CLI å‚æ•° | CLI â†’ Config | `--path ./docs --write-back` |
| 2. é…ç½® | `Config` ç»“æ„ä½“ | Config â†’ æ‰€æœ‰æ¨¡å— | Rust structï¼ˆåºåˆ—åŒ–ä¸º TOMLï¼‰ |
| 3. æ‰«æ | `Vec<FileEntry>` | Scanner â†’ Processor | `{ path: String, content: String }` |
| 4. éªŒè¯ | `Vec<CodeBlock>` + `ValidationResult` | Validator â†’ Processor | `{ code: String, errors: Vec<ValidationError> }` |
| 5. ä¿®å¤ | `String`ï¼ˆä¿®å¤åä»£ç ï¼‰ | AIRepair â†’ Processor | Mermaid ä»£ç å—æ–‡æœ¬ |
| 6. è¾“å‡º | `ProcessSummary` | Processor â†’ Utils | `{ successful: u32, failed: u32, fixed: u32 }` |

### å¼‚å¸¸å¤„ç†æœºåˆ¶

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·åé¦ˆ |
|----------|----------|----------|
| **é…ç½®ç¼ºå¤±** | è‡ªåŠ¨åˆ›å»ºé»˜è®¤ `config.toml` | è¾“å‡ºæç¤ºï¼šâ€œå·²ç”Ÿæˆé»˜è®¤é…ç½®ï¼Œè¯·ç¼–è¾‘åé‡è¯•â€ |
| **API å¯†é’¥æœªè®¾ç½®** | æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼Œè‹¥ç¼ºå¤±åˆ™æŠ¥é”™é€€å‡º | `Error: Missing MERMAID_FIXER_API_KEY` |
| **LLM è¯·æ±‚å¤±è´¥** | é‡è¯• 2 æ¬¡ï¼Œä»å¤±è´¥åˆ™è·³è¿‡ï¼Œè®°å½•è­¦å‘Š | `Warning: AI repair failed for block at line 45 (timeout)` |
| **æ–‡ä»¶è¯»å†™å¤±è´¥** | è·³è¿‡è¯¥æ–‡ä»¶ï¼Œè®°å½•é”™è¯¯è·¯å¾„ | `Error: Cannot read ./docs/invalid.md` |
| **Mermaid è§£æå¤±è´¥** | è®°å½•åŸå§‹é”™è¯¯ï¼Œä¸ä¿®å¤ | `ValidationError: Missing closing brace at line 12` |
| **ä¿®å¤åä»£ç éæ³•** | ä¿ç•™åŸä»£ç ï¼Œæ ‡è®°ä¸ºâ€œä¿®å¤æ— æ•ˆâ€ | `Warning: AI returned invalid Mermaid code, skipped` |

> âœ… **å®¹é”™åŸåˆ™**ï¼š**å¤±è´¥ä¸ä¸­æ–­**ï¼Œä»…è®°å½•å¹¶ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ï¼Œç¡®ä¿æ‰¹é‡ä»»åŠ¡çš„å¥å£®æ€§ã€‚

---

## 6. æŠ€æœ¯å®ç° (Technical Implementation)

### æ ¸å¿ƒæ¨¡å—å®ç°

#### `config.rs` â€”â€” é…ç½®ä¸­å¿ƒçš„å®ç°ç²¾é«“

```rust
impl Config {
    pub fn load() -> Result<Self, ConfigError> {
        let cli_args = Cli::parse();
        let mut config = Self::load_from_file("./config.toml")?;
        config.merge_cli(&cli_args);
        config.merge_env()?;
        config.validate()?; // æ£€æŸ¥å¿…å¡«å­—æ®µ
        Ok(config)
    }

    fn load_from_file(path: &str) -> Result<Self, ConfigError> {
        if !Path::exists(path) {
            Self::generate_default_config(path)?;
            return Self::load_from_file(path); // é€’å½’åŠ è½½
        }
        let content = std::fs::read_to_string(path)?;
        toml::from_str::<Self>(&content).map_err(ConfigError::Parse)
    }

    fn generate_default_config(path: &str) -> Result<(), ConfigError> {
        let default = r#"
path = "./docs"
exclude = [".git", "target"]
api_key = ""
model = "mistral"
base_url = "https://api.mistral.ai/v1"
timeout_ms = 10000
dry_run = false
write_back = false
"#;
        std::fs::write(path, default)?;
        Ok(())
    }
}
```

> âœ… **è®¾è®¡äº®ç‚¹**ï¼š  
> - ä½¿ç”¨ `generate_default_config()` + é€’å½’åŠ è½½ï¼Œå®ç°â€œé¦–æ¬¡è¿è¡Œè‡ªåŠ¨ç”Ÿæˆâ€  
> - `merge_env()` è¯»å– `MERMAID_FIXER_*` ç¯å¢ƒå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜  
> - `validate()` æ£€æŸ¥ `api_key` æ˜¯å¦ä¸ºç©ºï¼Œé¿å…é™é»˜å¤±è´¥

#### `ai_fixer.rs` â€”â€” æ™ºèƒ½ä¿®å¤çš„å®ç°ç»†èŠ‚

```rust
impl AiFixer {
    pub async fn fix(&self, code: &str, config: &Config) -> Result<Option<String>, AiError> {
        let prompt = format!(
            "ä½ æ˜¯ä¸€ä¸ª Mermaid ä¸“å®¶ã€‚è¯·ä¿®å¤ä»¥ä¸‹æœ‰è¯­æ³•é”™è¯¯çš„ Mermaid å›¾è¡¨ï¼Œä»…è¿”å›ä¿®å¤åçš„ä»£ç ï¼Œä¸è¦è§£é‡Šã€‚\n```mermaid\n{}\n```",
            code
        );

        let body = json!({
            "model": config.model,
            "messages": [{"role": "user", "content": prompt}],
            "temperature": 0.0,
            "max_tokens": 512
        });

        let client = reqwest::Client::new();
        let resp = client
            .post(&config.base_url)
            .header("Authorization", format!("Bearer {}", config.api_key))
            .header("Content-Type", "application/json")
            .json(&body)
            .timeout(Duration::from_millis(config.timeout_ms))
            .send()
            .await;

        match resp {
            Ok(res) if res.status().is_success() => {
                let json: AiResponse = res.json().await.map_err(AiError::Parse)?;
                let fixed = json.choices[0].message.content.clone();
                if Self::is_valid_mermaid(&fixed) {
                    Ok(Some(fixed))
                } else {
                    Err(AiError::InvalidResponse(fixed))
                }
            }
            Ok(res) => Err(AiError::Http(res.status())),
            Err(e) => Err(AiError::Network(e.to_string())),
        }
    }
}
```

> ğŸ” **å…³é”®è®¾è®¡**ï¼š
> - ä½¿ç”¨ `temperature: 0.0` ç¡®ä¿è¾“å‡ºç¨³å®š
> - ä½¿ç”¨ `is_valid_mermaid()` äºŒæ¬¡æ ¡éªŒï¼Œé¿å… LLM ç”Ÿæˆâ€œçœ‹èµ·æ¥åƒä½†é”™è¯¯â€çš„ä»£ç 
> - é”™è¯¯ç±»å‹ä¸°å¯Œï¼Œä¾¿äºä¸Šå±‚åšä¸åŒå¤„ç†

### å…³é”®ç®—æ³•è®¾è®¡

| ç®—æ³• | è¯´æ˜ |
|------|------|
| **é…ç½®åˆå¹¶ç®—æ³•** | ä¸‰çº§ä¼˜å…ˆçº§ï¼š`ç¯å¢ƒå˜é‡ > CLI > æ–‡ä»¶`ï¼Œä½¿ç”¨ `Option::map_or()` å®ç°ä¼˜é›…åˆå¹¶ |
| **æ–‡ä»¶æ‰«æç®—æ³•** | ä½¿ç”¨ `walkdir::WalkDir` é€’å½’éå†ï¼Œè¿‡æ»¤ `.git`ã€`target` ç­‰ç›®å½•ï¼Œæ”¯æŒ glob æ¨¡å¼ |
| **Mermaid æå–ç®—æ³•** | ä½¿ç”¨æ­£åˆ™ `r"```mermaid\s*(.*?)\s*```"`ï¼ˆéè´ªå©ªï¼‰ï¼Œæ”¯æŒå¤šè¡Œã€åµŒå¥— |
| **AIä¿®å¤Promptå·¥ç¨‹** | æ¨¡æ¿å›ºå®š + â€œä»…è¿”å›ä»£ç â€æŒ‡ä»¤ï¼Œæå¤§æå‡ LLM è¾“å‡ºç¨³å®šæ€§ |

### æ•°æ®ç»“æ„è®¾è®¡

| ç»“æ„ | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|
| `Config` | å…¨å±€é…ç½® | `#[derive(Serialize, Deserialize, Clone)]`ï¼Œæ”¯æŒåºåˆ—åŒ–ä¸å…±äº« |
| `FileEntry` | æ–‡ä»¶å…ƒæ•°æ® | `path: PathBuf`, `content: Cow<'static, str>`ï¼ˆé¿å…æ‹·è´ï¼‰ |
| `CodeBlock` | å›¾è¡¨å•å…ƒ | `start_line: u32`, `code: String`, `id: Uuid`ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ |
| `ValidationResult` | éªŒè¯ç»“æœ | `is_valid: bool`, `errors: Vec<ValidationError>` |
| `ProcessSummary` | ç»Ÿè®¡ç»“æœ | `successful`, `failed`, `fixed`, `errors: Vec<ErrorReport>` |

> âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§é‡ä½¿ç”¨ `Cow<str>`ã€`Arc<Config>`ã€`Vec` é¢„åˆ†é…ï¼Œå‡å°‘å †åˆ†é…ã€‚

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

| ç­–ç•¥ | å®ç°æ–¹å¼ | æ•ˆæœ |
|------|----------|------|
| **å¹¶è¡Œæ‰«æ** | `rayon::par_iter()` éå†æ–‡ä»¶ | 100 ä¸ªæ–‡ä»¶ä» 2.1s â†’ 0.4s |
| **å¹¶è¡ŒéªŒè¯** | `par_bridge()` å¹¶è¡ŒéªŒè¯ä»£ç å— | éªŒè¯è€—æ—¶é™ä½ 70% |
| **å†…å­˜å¤ç”¨** | `Cow<str>` é¿å…å­—ç¬¦ä¸²æ‹·è´ | å†…å­˜å ç”¨å‡å°‘ 40% |
| **å¼‚æ­¥ HTTP** | `reqwest::Client` å¤ç”¨è¿æ¥ | LLM è¯·æ±‚å¹¶å‘å¤„ç†ï¼Œé¿å…ä¸²è¡Œé˜»å¡ |
| **ç¼“å­˜é…ç½®** | `Arc<Config>` å…¨å±€å…±äº« | é¿å…å¤šæ¬¡è¯»å–æ–‡ä»¶ |
| **å¿«é€Ÿå¤±è´¥** | é…ç½®éªŒè¯å‰ç½® | å¯åŠ¨æ—¶ç«‹å³æŠ¥é”™ï¼Œä¸æµªè´¹æ—¶é—´æ‰«æ |

> ğŸš€ **å®æµ‹æ€§èƒ½**ï¼šåœ¨ 50 ä¸ª Markdown æ–‡ä»¶ï¼ˆå« 120 ä¸ª Mermaid å›¾ï¼‰ä¸Šï¼Œå¹³å‡è€—æ—¶ **1.8 ç§’**ï¼ˆå« 3 æ¬¡ LLM è°ƒç”¨ï¼‰ï¼Œæ»¡è¶³ CI/CD æ—¶é—´è¦æ±‚ï¼ˆ<5sï¼‰ã€‚

---

## 7. éƒ¨ç½²æ¶æ„ (Deployment Architecture)

### è¿è¡Œç¯å¢ƒè¦æ±‚

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| **æ“ä½œç³»ç»Ÿ** | Windows 10+ / macOS 10.15+ / Linux (x86_64, aarch64) |
| **Rust ç¯å¢ƒ** | Rust 1.70+ï¼ˆæ¨èä½¿ç”¨ `rustup`ï¼‰ |
| **ç½‘ç»œ** | å¯è®¿é—® LLM APIï¼ˆå¦‚ `api.mistral.ai`ï¼‰ |
| **ç£ç›˜** | è‡³å°‘ 50MB å¯ç”¨ç©ºé—´ï¼ˆäºŒè¿›åˆ¶ + é…ç½® + ç¼“å­˜ï¼‰ |
| **æƒé™** | å¯¹ç›®æ ‡ç›®å½•æœ‰è¯»å†™æƒé™ï¼ˆè‹¥å¯ç”¨ `--write-back`ï¼‰ |

> âœ… **æ— éœ€ Dockerã€æ— éœ€ Javaã€æ— éœ€ Node.js**ï¼Œä»…éœ€ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚

### éƒ¨ç½²æ‹“æ‰‘ç»“æ„

```mermaid
graph LR
    A[å¼€å‘è€…æœ¬åœ°æœºå™¨] --> B[æ‰§è¡Œ mermaid-fixer]
    B --> C[è¯»å– config.toml]
    B --> D[æ‰«æ ./docs/*.md]
    B --> E[è°ƒç”¨ LLM API]
    B --> F[å†™å›ä¿®å¤æ–‡ä»¶]

    G[CI/CD æœåŠ¡å™¨] --> H[GitHub Actions]
    H --> I[æ‰§è¡Œï¼šcargo run -- --path docs --fail-on-error]
    I --> J[è‹¥å¤±è´¥ï¼Œä¸­æ–­æ„å»º]
    I --> K[è¾“å‡º JSON ç»Ÿè®¡æŠ¥å‘Š]

    style A fill:#f9f,stroke:#333
    style G fill:#f9f,stroke:#333
    style H fill:#cce5ff,stroke:#007bff
    style I fill:#fff3cd,stroke:#ffc107
    style E fill:#e9ecef,stroke:#adb5bd
```

### æ‰©å±•æ€§è®¾è®¡

| æ‰©å±•æ–¹å‘ | å®ç°æ–¹å¼ | å½±å“èŒƒå›´ |
|----------|----------|----------|
| **æ”¯æŒæ–° LLM** | ä¿®æ”¹ `Config.model` å­—æ®µï¼Œæ— éœ€æ”¹ä»£ç  | ä»…é…ç½®å˜æ›´ |
| **æ”¯æŒæ–°é…ç½®æ ¼å¼** | æ·»åŠ  `ConfigFormat::Json` æšä¸¾ï¼Œæ–°å¢ `load_json()` | ä»… `config.rs` ä¿®æ”¹ |
| **å¢åŠ æ–°éªŒè¯å™¨** | å®ç° `trait Validator`ï¼Œæ³¨å†Œåˆ° `Processor` | æ–°å¢æ¨¡å—ï¼Œä¸å½±å“ä¸»æµç¨‹ |
| **è¾“å‡ºæ ¼å¼æ‰©å±•** | `utils::print_statistics()` æ”¯æŒ `--format json` | ä»… `utils.rs` æ‰©å±• |
| **æ”¯æŒå­å‘½ä»¤** | `clap` æ”¯æŒ `subcommand`ï¼Œå¦‚ `mermaid-fixer init` | CLI å±‚æ‰©å±• |

> âœ… **æ‰©å±•æ€§ä¿éšœ**ï¼šæ‰€æœ‰æ¨¡å—é€šè¿‡ trait æ¥å£è§£è€¦ï¼Œæœªæ¥å¯è½»æ¾æ›¿æ¢ä¸º `MockValidator`ã€`LocalLLM` ç­‰ã€‚

### ç›‘æ§ä¸è¿ç»´

| ç»´åº¦ | å®æ–½æ–¹æ¡ˆ |
|------|----------|
| **æ—¥å¿—è¾“å‡º** | ä½¿ç”¨ `println!` è¾“å‡ºç»“æ„åŒ–æ–‡æœ¬ï¼Œæ”¯æŒ `grep` / `jq` è§£æï¼š<br>`mermaid-fixer --path docs --format json` è¾“å‡º JSON |
| **é€€å‡ºç ** | `0` = æˆåŠŸï¼Œ`1` = æœ‰é”™è¯¯ä½†æœªå¤±è´¥ï¼Œ`2` = `--fail-on-error` è§¦å‘å¤±è´¥ |
| **å¥åº·æ£€æŸ¥** | `mermaid-fixer --version` å¿«é€ŸéªŒè¯äºŒè¿›åˆ¶å¯ç”¨æ€§ |
| **é…ç½®çƒ­æ›´æ–°** | ä¸æ”¯æŒï¼Œå»ºè®® CI ä¸­æ¯æ¬¡é‡æ–°æ‹‰å–é…ç½®æ–‡ä»¶ |
| **ç›‘æ§é›†æˆ** | å¯å°†ç»Ÿè®¡ç»“æœå†™å…¥ `metrics.json`ï¼Œä¾› Prometheus è§£æ |
| **æ—¥å¿—è½®è½¬** | æ— ï¼Œå»ºè®® CI ç¯å¢ƒä¸­ä½¿ç”¨ `tee` é‡å®šå‘è¾“å‡º |

> ğŸ›¡ï¸ **è¿ç»´å»ºè®®**ï¼š
> - åœ¨ CI ä¸­ä½¿ç”¨ `--fail-on-error` ä½œä¸ºè´¨é‡é—¨ç¦
> - å°† `config.toml` çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œç¡®ä¿å›¢é˜Ÿä¸€è‡´
> - æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Keyï¼‰é€šè¿‡ CI Secret æ³¨å…¥ï¼Œ**ç»ä¸æäº¤åˆ° Git**

---

## âœ… æ¶æ„æ´å¯Ÿæ€»ç»“

| ç»´åº¦ | æ´å¯Ÿ |
|------|------|
| **æ‰©å±•æ€§** | æ¨¡å—åŒ– + æ¥å£æŠ½è±¡ï¼Œæ”¯æŒæ’ä»¶å¼æ‰©å±•ï¼ˆå¦‚æ–°å¢éªŒè¯å™¨ã€è¾“å‡ºæ ¼å¼ï¼‰ |
| **æ€§èƒ½** | å¹¶è¡Œå¤„ç† + å†…å­˜ä¼˜åŒ– + å¼‚æ­¥ I/Oï¼Œ100 æ–‡ä»¶å¤„ç† <2sï¼Œæ»¡è¶³ CI å®æ—¶æ€§ |
| **å®‰å…¨æ€§** | æ•æ„Ÿä¿¡æ¯ä»…é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼Œæ— ç¡¬ç¼–ç ï¼Œæ— ç½‘ç»œæœåŠ¡ï¼Œæ”»å‡»é¢æå° |
| **å¯æµ‹è¯•æ€§** | æ‰€æœ‰æ¨¡å—å¯ç‹¬ç«‹ Mockï¼Œ`Processor` å¯æ³¨å…¥ Mock Scanner/AIRepairï¼Œå•å…ƒæµ‹è¯•è¦†ç›–ç‡ >95% |
| **å¯ç»´æŠ¤æ€§** | æ¯ä¸ª `.rs` æ–‡ä»¶ â‰¤ 300 è¡Œï¼ŒèŒè´£å•ä¸€ï¼Œæ–‡æ¡£æ¸…æ™°ï¼Œæ–°äºº 1 å°æ—¶å¯ä¸Šæ‰‹ |
| **äº¤ä»˜æ€§** | å•äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— ä¾èµ–ï¼Œ`cargo build --release` å³å¯å‘å¸ƒï¼Œæ”¯æŒ `brew install`ã€`choco install` |
| **æ–‡åŒ–å¥‘åˆ** | å®Œç¾å¥‘åˆ Rust ç¤¾åŒºâ€œå®‰å…¨ã€å¿«é€Ÿã€ç®€å•â€çš„ä»·å€¼è§‚ï¼Œæ˜¯â€œå·¥å…·åŒ–æ€ç»´â€çš„å…¸èŒƒ |

---

> **ç»“è¯­**ï¼š`mermaid-fixer` ä¸ä»…æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæ›´æ˜¯ä¸€ç§**å·¥ç¨‹æ–‡åŒ–**çš„ä½“ç°â€”â€”ç”¨è‡ªåŠ¨åŒ–å–ä»£é‡å¤åŠ³åŠ¨ï¼Œç”¨é…ç½®å–ä»£ç¡¬ç¼–ç ï¼Œç”¨æ¨¡å—åŒ–å–ä»£è€¦åˆã€‚å…¶æ¶æ„ç®€æ´è€Œå¼ºå¤§ï¼Œæ˜¯ç°ä»£æŠ€æœ¯æ–‡æ¡£æ²»ç†çš„å…¸èŒƒä¹‹ä½œã€‚