# **æŠ€æœ¯æ–‡æ¡£ï¼šå¤„ç†åè°ƒåŸŸï¼ˆProcessor Domainï¼‰**

---

## **1. æ¦‚è¿°**

**å¤„ç†åè°ƒåŸŸ**ï¼ˆProcessor Domainï¼‰æ˜¯ `mermaid-fixer` ç³»ç»Ÿçš„æ ¸å¿ƒæµç¨‹æ§åˆ¶ä¸­æ¢ï¼Œè´Ÿè´£**ç¼–æ’ã€è°ƒåº¦ä¸åè°ƒ**æ•´ä¸ª Mermaid å›¾è¡¨è‡ªåŠ¨åŒ–ä¿®å¤æµç¨‹ã€‚å®ƒä¸ç›´æ¥å®ç°è¯­æ³•è§£æã€æ–‡ä»¶æ‰«ææˆ– AI ä¿®å¤ç­‰å…·ä½“ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ˜¯ä½œä¸ºâ€œæŒ‡æŒ¥å®˜â€ï¼ˆOrchestratorï¼‰ï¼Œé€šè¿‡ç»„åˆå’Œè°ƒç”¨å…¶ä»–ç‹¬ç«‹æ¨¡å—ï¼ˆæ–‡ä»¶æ‰«æã€è¯­æ³•éªŒè¯ã€AI ä¿®å¤ï¼‰ï¼Œå®ç°ç«¯åˆ°ç«¯çš„æ–‡æ¡£è´¨é‡ä¿®å¤é—­ç¯ã€‚

è¯¥æ¨¡å—çš„è®¾è®¡ä¸¥æ ¼éµå¾ª **â€œå•ä¸€èŒè´£åŸåˆ™â€** ä¸ **â€œæ§åˆ¶ä¸å®ç°åˆ†ç¦»â€** çš„æ¶æ„ç†å¿µï¼Œç¡®ä¿ç³»ç»Ÿå…·å¤‡é«˜å†…èšã€ä½è€¦åˆã€æ˜“æµ‹è¯•ã€å¯æ‰©å±•çš„ç‰¹æ€§ã€‚å…¶æ ¸å¿ƒä»·å€¼åœ¨äºï¼š**å°†å¤æ‚çš„å¤šæ­¥éª¤è‡ªåŠ¨åŒ–æµç¨‹æŠ½è±¡ä¸ºå¯é…ç½®ã€å¯è§‚å¯Ÿã€å¯å¤ç”¨çš„åè°ƒé€»è¾‘**ï¼Œä½¿ç³»ç»Ÿåœ¨ä¿æŒè½»é‡çº§çš„åŒæ—¶ï¼Œå…·å¤‡å·¥ä¸šçº§çš„ç¨³å®šæ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

---

## **2. æ ¸å¿ƒèŒè´£**

å¤„ç†åè°ƒåŸŸæ‰¿æ‹…ä»¥ä¸‹å…³é”®èŒè´£ï¼š

| èŒè´£ | æè¿° |
|------|------|
| **æµç¨‹ç¼–æ’** | æŒ‰ç…§é¢„å®šä¹‰å·¥ä½œæµï¼ˆæ‰«æ â†’ éªŒè¯ â†’ ä¿®å¤ â†’ å†™å›ï¼‰æœ‰åºè°ƒç”¨å„å­æ¨¡å—ï¼Œç¡®ä¿æµç¨‹é€»è¾‘æ­£ç¡®ã€æ— é—æ¼ã€‚ |
| **æ‰§è¡Œç­–ç•¥æ§åˆ¶** | æ ¹æ®é…ç½®ï¼ˆå¦‚ `dry_run`ã€`enable_ai_repair`ï¼‰åŠ¨æ€å†³å®šæ˜¯å¦æ‰§è¡Œä¿®å¤ã€æ˜¯å¦å†™å›æ–‡ä»¶ï¼Œå®ç°â€œå¹²è¿è¡Œâ€ä¸â€œå®é™…ä¿®å¤â€æ¨¡å¼åˆ‡æ¢ã€‚ |
| **çŠ¶æ€èšåˆä¸ç»Ÿè®¡** | æ”¶é›†å„å­æ¨¡å—çš„å¤„ç†ç»“æœï¼ˆæˆåŠŸã€å¤±è´¥ã€ä¿®å¤æ¬¡æ•°ã€è·³è¿‡æ•°ç­‰ï¼‰ï¼Œæ„å»ºç»Ÿä¸€çš„ `ProcessResult` ç»Ÿè®¡å¯¹è±¡ï¼Œä¸ºæœ€ç»ˆè¾“å‡ºæä¾›æ•°æ®åŸºç¡€ã€‚ |
| **å¼‚å¸¸è¾¹ç•Œå¤„ç†** | å¯¹å­æ¨¡å—è°ƒç”¨å¤±è´¥ï¼ˆå¦‚ç½‘ç»œè¶…æ—¶ã€æ–‡ä»¶æƒé™é”™è¯¯ï¼‰è¿›è¡Œå®¹é”™å¤„ç†ï¼Œé¿å…æµç¨‹ä¸­æ–­ï¼Œç¡®ä¿â€œéƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“è¿è¡Œâ€ã€‚ |
| **æ–‡ä»¶å†™å›å†³ç­–** | åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å› ä¿®å¤è€Œè¢«ä¿®æ”¹ï¼Œä»…åœ¨å¿…è¦æ—¶æ‰§è¡Œå†™å…¥æ“ä½œï¼Œé¿å…æ— æ„ä¹‰çš„ç£ç›˜ I/O å’Œç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿå˜æ›´ã€‚ |
| **å¼‚æ­¥æµç¨‹ç®¡ç†** | åœ¨å¼‚æ­¥è¿è¡Œæ—¶ç¯å¢ƒä¸­ï¼ˆRust `async/await`ï¼‰ï¼Œåè°ƒå¤šä¸ª I/O å¯†é›†å‹æ“ä½œï¼ˆæ–‡ä»¶è¯»å†™ã€HTTP è¯·æ±‚ï¼‰ï¼Œæå‡ååæ•ˆç‡ã€‚ |

> âœ… **è®¾è®¡å“²å­¦**ï¼š**â€œä¸å®ç°ä¸šåŠ¡ï¼Œåªè°ƒåº¦ä¸šåŠ¡â€** â€”â€” æ‰€æœ‰å…·ä½“é€»è¾‘å‡ç”±ç‹¬ç«‹æ¨¡å—å®ç°ï¼Œå¤„ç†åè°ƒåŸŸä»…è´Ÿè´£â€œä½•æ—¶è°ƒç”¨ã€å¦‚ä½•ç»„åˆã€ç»“æœå¦‚ä½•æ±‡æ€»â€ã€‚

---

## **3. æ¶æ„ä¸æ¨¡å—äº¤äº’**

### **3.1 æ¨¡å—ä¾èµ–å…³ç³»å›¾ï¼ˆé€»è¾‘è§†å›¾ï¼‰**

```mermaid
graph LR
    A[CLIå…¥å£åŸŸ] -->|è°ƒç”¨| B[å¤„ç†åè°ƒåŸŸ]
    B -->|è°ƒç”¨| C[æ–‡ä»¶æ‰«æåŸŸ]
    B -->|è°ƒç”¨| D[è¯­æ³•éªŒè¯åŸŸ]
    B -->|æ¡ä»¶è°ƒç”¨| E[AIä¿®å¤åŸŸ]
    B -->|è°ƒç”¨| F[å·¥å…·æ”¯æŒåŸŸ]
    C -->|è¿”å›æ–‡ä»¶åˆ—è¡¨| B
    D -->|è¿”å›éªŒè¯ç»“æœ| B
    E -->|è¿”å›ä¿®å¤åä»£ç | B
    F -->|æ ¼å¼åŒ–è¾“å‡º| B
    G[é…ç½®ç®¡ç†åŸŸ] -->|æ³¨å…¥é…ç½®| B
    G -->|æ³¨å…¥é…ç½®| C
    G -->|æ³¨å…¥é…ç½®| D
    G -->|æ³¨å…¥é…ç½®| E

    style B fill:#fff3cd,stroke:#ffc107
    style G fill:#d4edda,stroke:#28a745
    style C fill:#e2e3e5,stroke:#6c757d
    style D fill:#e2e3e5,stroke:#6c757d
    style E fill:#e2e3e5,stroke:#6c757d
    style F fill:#f8d7da,stroke:#dc3545
```

### **3.2 ä¾èµ–æ³¨å…¥æ¨¡å¼**

å¤„ç†åè°ƒåŸŸé‡‡ç”¨ **ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰** æ¨¡å¼ï¼Œæ‰€æœ‰å­æ¨¡å—é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ï¼Œå®ç°ï¼š

- **è§£è€¦**ï¼šæ— éœ€ç¡¬ç¼–ç æ¨¡å—å®ç°ï¼Œä¾¿äºæ›¿æ¢ï¼ˆå¦‚ç”¨ Mock æ›¿ä»£çœŸå® AI ä¿®å¤å™¨ï¼‰ã€‚
- **å¯æµ‹è¯•æ€§**ï¼šå¯æ³¨å…¥æ¨¡æ‹Ÿå¯¹è±¡ï¼ˆMockï¼‰è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œæ— éœ€çœŸå®ç½‘ç»œæˆ–æ–‡ä»¶ç³»ç»Ÿã€‚
- **é…ç½®é©±åŠ¨**ï¼šå­æ¨¡å—çš„é…ç½®ï¼ˆå¦‚ LLM API å¯†é’¥ã€è¶…æ—¶ï¼‰ç”±é…ç½®ç®¡ç†åŸŸç»Ÿä¸€æ³¨å…¥ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

```rust
// src/processor.rs - æ ¸å¿ƒç»“æ„ä½“å®šä¹‰
pub struct MermaidProcessor<'a> {
    scanner: &'a dyn MarkdownScanner,
    validator: &'a dyn MermaidValidator,
    ai_fixer: Option<&'a dyn AiFixer>, // å¯é€‰ï¼Œç”±é…ç½®å†³å®šæ˜¯å¦å¯ç”¨
    config: &'a Config,
}

impl<'a> MermaidProcessor<'a> {
    pub fn new(
        scanner: &'a dyn MarkdownScanner,
        validator: &'a dyn MermaidValidator,
        ai_fixer: Option<&'a dyn AiFixer>,
        config: &'a Config,
    ) -> Self {
        Self {
            scanner,
            validator,
            ai_fixer,
            config,
        }
    }
}
```

> ğŸ” **å…³é”®è®¾è®¡ç‚¹**ï¼š`ai_fixer` ä¸º `Option<&dyn AiFixer>`ï¼Œåœ¨ `dry_run` æˆ– `enable_ai_repair=false` æ—¶ä¸º `None`ï¼Œé¿å…æ— æ•ˆè°ƒç”¨ã€‚

---

## **4. æ ¸å¿ƒç®—æ³•æµç¨‹ï¼ˆè¯¦ç»†é€»è¾‘ï¼‰**

### **4.1 ä¸»æµç¨‹ï¼š`process_directory()`**

```mermaid
sequenceDiagram
    participant Client
    participant Processor
    participant Scanner
    participant Validator
    participant AiFixer

    Client->>Processor: process_directory(dir, dry_run=true)
    Processor->>Scanner: scan_directory(dir)
    Scanner-->>Processor: [file1.md, file2.md, ...]
    alt æ— æ–‡ä»¶
        Processor->>Processor: è¿”å›ç©º ProcessResult
    else æœ‰æ–‡ä»¶
        loop å¯¹æ¯ä¸ªæ–‡ä»¶
            Processor->>Processor: extract_mermaid_blocks(file.content)
            alt æ—  Mermaid å—
                Processor->>Processor: è®°å½•ï¼šè·³è¿‡æ–‡ä»¶
            else æœ‰å—
                loop å¯¹æ¯ä¸ªä»£ç å—
                    Processor->>Validator: validate(mermaid_code)
                    alt éªŒè¯é€šè¿‡
                        Validator-->>Processor: Ok()
                        Processor->>Processor: è®°å½•ï¼šæœ‰æ•ˆå— +1
                    else éªŒè¯å¤±è´¥
                        Validator-->>Processor: Err(InvalidSyntax)
                        Processor->>Processor: è®°å½•ï¼šæ— æ•ˆå— +1
                        alt dry_run == true
                            Processor->>Processor: è®°å½•ï¼šéœ€ä¿®å¤ä½†æœªæ‰§è¡Œï¼ˆå¹²è¿è¡Œï¼‰
                        else
                            alt ai_fixer.is_some()
                                Processor->>AiFixer: fix_mermaid(mermaid_code)
                                AiFixer-->>Processor: fixed_code
                                Processor->>Validator: validate(fixed_code)
                                alt ä¿®å¤åæœ‰æ•ˆ
                                    Validator-->>Processor: Ok()
                                    Processor->>Processor: æ›¿æ¢åŸä»£ç ï¼Œæ ‡è®°æ–‡ä»¶ä¸ºâ€œå·²ä¿®æ”¹â€
                                    Processor->>Processor: è®°å½•ï¼šä¿®å¤æˆåŠŸ +1
                                else
                                    Validator-->>Processor: Err(StillInvalid)
                                    Processor->>Processor: è®°å½•ï¼šä¿®å¤å¤±è´¥ï¼ˆAI æœªèƒ½ä¿®å¤ï¼‰
                                end
                            else
                                Processor->>Processor: è®°å½•ï¼šAI ä¿®å¤æœªå¯ç”¨
                            end
                        end
                    end
                end
            end
            Processor->>Processor: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹
            alt æ˜¯
                Processor->>Processor: write_file(file_path, new_content)
                Processor->>Processor: è®°å½•ï¼šå†™å›æ–‡ä»¶ +1
            end
        end
    end
    Processor->>Processor: æ±‡æ€»æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯
    Processor->>Utils: print_statistics(result)
    Processor-->>Client: ProcessResult { total_files, total_blocks, valid, invalid, repaired, failed, written }
```

### **4.2 å…³é”®å†³ç­–é€»è¾‘**

| åˆ¤æ–­ç‚¹ | æ¡ä»¶ | è¡Œä¸º |
|--------|------|------|
| **æ˜¯å¦å¯ç”¨ AI ä¿®å¤** | `config.enable_ai_repair == true` ä¸” `ai_fixer.is_some()` | æ‰è¿›å…¥ä¿®å¤æµç¨‹ |
| **æ˜¯å¦å†™å›æ–‡ä»¶** | `dry_run == false` ä¸” **è‡³å°‘ä¸€ä¸ªä»£ç å—è¢«ä¿®å¤** | æ‰§è¡Œæ–‡ä»¶å†™å…¥ |
| **ä¿®å¤åæ˜¯å¦æœ‰æ•ˆ** | ä¿®å¤åå†æ¬¡è°ƒç”¨ `validate(fixed_code)` | å¿…é¡»äºŒæ¬¡éªŒè¯ï¼Œç¡®ä¿ AI è¾“å‡ºç¬¦åˆè¯­æ³•è§„èŒƒ |
| **æ–‡ä»¶æ˜¯å¦ä¿®æ”¹** | ä»…å½“è‡³å°‘ä¸€ä¸ªä»£ç å—è¢«æ›¿æ¢æ—¶ä¸º `true` | é¿å…æ— å˜æ›´çš„å†™å…¥ï¼Œå‡å°‘ Git æäº¤å™ªå£° |

> âœ… **é‡è¦åŸåˆ™**ï¼š**â€œä¿®å¤ â‰  å†™å…¥â€**ã€‚AI å¯èƒ½å¤±è´¥ï¼Œå³ä½¿è°ƒç”¨äº†ä¿®å¤å™¨ï¼Œä¹Ÿå¿…é¡»äºŒæ¬¡éªŒè¯ï¼Œç¡®ä¿è¾“å‡ºåˆæ³•ã€‚å†™å…¥æ“ä½œä»…åœ¨**ç¡®è®¤ä¿®æ”¹æœ‰æ•ˆ**åæ‰æ‰§è¡Œã€‚

---

## **5. æ•°æ®ç»“æ„è®¾è®¡**

### **5.1 æ ¸å¿ƒç»“æœç»“æ„ä½“**

```rust
// src/processor.rs

#[derive(Debug, Clone, Default)]
pub struct ProcessResult {
    pub total_files: usize,           // æ€»æ‰«ææ–‡ä»¶æ•°
    pub total_blocks: usize,          // æ€» Mermaid ä»£ç å—æ•°
    pub valid_blocks: usize,          // è¯­æ³•æœ‰æ•ˆçš„å—æ•°
    pub invalid_blocks: usize,        // è¯­æ³•æ— æ•ˆçš„å—æ•°
    pub repaired_blocks: usize,       // æˆåŠŸä¿®å¤çš„å—æ•°
    pub failed_repair_blocks: usize,  // AI ä¿®å¤å¤±è´¥çš„å—æ•°
    pub written_files: usize,         // å®é™…å†™å›çš„æ–‡ä»¶æ•°
    pub skipped_files: usize,         // æ—  Mermaid å—çš„æ–‡ä»¶æ•°
}

#[derive(Debug, Clone)]
pub struct FileProcessResult {
    pub file_path: PathBuf,
    pub blocks_processed: usize,
    pub blocks_valid: usize,
    pub blocks_invalid: usize,
    pub blocks_repaired: usize,
    pub blocks_failed_repair: usize,
    pub modified: bool, // æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆå†³å®šæ˜¯å¦å†™å›ï¼‰
}
```

### **5.2 çŠ¶æ€è¿½è¸ªæœºåˆ¶**

- æ¯ä¸ªæ–‡ä»¶å¤„ç†åç”Ÿæˆ `FileProcessResult`ï¼Œè®°å½•ç»†ç²’åº¦ç»Ÿè®¡ã€‚
- æ‰€æœ‰ `FileProcessResult` è¢«èšåˆä¸º `ProcessResult`ï¼Œä½œä¸ºæœ€ç»ˆè¾“å‡ºã€‚
- æ‰€æœ‰çŠ¶æ€å‡ä¸º **ä¸å¯å˜ç»“æ„ä½“**ï¼Œé¿å…å¹¶å‘ä¿®æ”¹é£é™©ï¼Œç¬¦åˆ Rust å®‰å…¨èŒƒå¼ã€‚

---

## **6. å¼‚æ­¥ä¸æ€§èƒ½ä¼˜åŒ–**

### **6.1 å¼‚æ­¥æ¨¡å‹è®¾è®¡**

å¤„ç†åè°ƒåŸŸé‡‡ç”¨ **å¼‚æ­¥éé˜»å¡æ¨¡å‹**ï¼ˆ`async/await`ï¼‰ï¼Œä¸»è¦ä¼˜åŒ–ç‚¹ï¼š

| æ“ä½œ | å¼‚æ­¥åŒ–åŸå›  |
|------|------------|
| æ–‡ä»¶è¯»å†™ | é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œæå‡ I/O å¹¶å‘èƒ½åŠ› |
| LLM API è°ƒç”¨ | ç½‘ç»œå»¶è¿Ÿé«˜ï¼Œå¼‚æ­¥å¯å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚ |
| æ—¥å¿—è¾“å‡º | é¿å…åŒæ­¥å†™å…¥å½±å“ä¸»æµç¨‹ |

```rust
impl<'a> MermaidProcessor<'a> {
    pub async fn process_directory(&self, dir: &Path) -> Result<ProcessResult, ProcessorError> {
        let files = self.scanner.scan_directory(dir).await?;
        let mut results = Vec::new();

        for file in files {
            let result = self.process_single_file(&file).await?;
            results.push(result);
        }

        Ok(ProcessResult::aggregate(results))
    }

    async fn process_single_file(&self, file_path: &Path) -> Result<FileProcessResult, ProcessorError> {
        let content = fs::read_to_string(file_path).await?;
        let blocks = extract_mermaid_blocks(&content); // å·¥å…·å‡½æ•°

        let mut modified = false;
        let mut repaired_count = 0;
        let mut failed_count = 0;

        let mut new_content = content.clone();
        for (idx, block) in blocks.iter().enumerate() {
            match self.validator.validate(&block.code).await {
                Ok(_) => { /* è®°å½•æœ‰æ•ˆ */ }
                Err(_) => {
                    if !self.config.dry_run && self.ai_fixer.is_some() {
                        match self.ai_fixer.unwrap().fix_mermaid(&block.code).await {
                            Ok(fixed) => {
                                if self.validator.validate(&fixed).await.is_ok() {
                                    new_content = new_content.replace(&block.code, &fixed);
                                    repaired_count += 1;
                                    modified = true;
                                } else {
                                    failed_count += 1;
                                }
                            }
                            Err(_) => failed_count += 1,
                        }
                    }
                }
            }
        }

        if modified && !self.config.dry_run {
            fs::write(file_path, new_content).await?;
        }

        Ok(FileProcessResult {
            file_path: file_path.to_path_buf(),
            blocks_processed: blocks.len(),
            blocks_valid: ...,
            blocks_invalid: ...,
            blocks_repaired: repaired_count,
            blocks_failed_repair: failed_count,
            modified,
        })
    }
}
```

> âœ… **ä¼˜åŠ¿**ï¼šåœ¨å¤„ç† 100+ æ–‡ä»¶æ—¶ï¼Œå¼‚æ­¥å¹¶å‘å¯å°†æ€»è€—æ—¶ä»åˆ†é’Ÿçº§é™è‡³ç§’çº§ï¼Œå°¤å…¶åœ¨ LLM API å“åº”å»¶è¿Ÿé«˜çš„åœºæ™¯ä¸‹è¡¨ç°æ˜¾è‘—ã€‚

---

## **7. é”™è¯¯å¤„ç†ä¸å®¹é”™æœºåˆ¶**

å¤„ç†åè°ƒåŸŸé‡‡ç”¨ **â€œå¤±è´¥ä¸ä¸­æ–­â€** çš„å®¹é”™ç­–ç•¥ï¼š

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|----------|----------|
| æ–‡ä»¶è¯»å–å¤±è´¥ï¼ˆæƒé™/ä¸å­˜åœ¨ï¼‰ | è®°å½•é”™è¯¯æ—¥å¿—ï¼Œè·³è¿‡è¯¥æ–‡ä»¶ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ |
| è¯­æ³•éªŒè¯å¤±è´¥ | è®°å½•ä¸ºâ€œæ— æ•ˆå—â€ï¼Œç»§ç»­å¤„ç†åç»­å— |
| AI ä¿®å¤å¤±è´¥ï¼ˆç½‘ç»œè¶…æ—¶ã€API é”™è¯¯ï¼‰ | è®°å½•ä¸ºâ€œä¿®å¤å¤±è´¥â€ï¼Œä¸ä¸­æ–­æµç¨‹ï¼Œä¸å†™å› |
| ä¿®å¤åéªŒè¯å¤±è´¥ | è®°å½•ä¸ºâ€œä¿®å¤å¤±è´¥â€ï¼Œä¸å†™å›ï¼Œä¿ç•™åŸå†…å®¹ |
| å†™å›æ–‡ä»¶å¤±è´¥ï¼ˆç£ç›˜æ»¡ã€æƒé™ï¼‰ | è®°å½•é”™è¯¯ï¼Œä½†ä¸ç»ˆæ­¢æµç¨‹ï¼Œç»§ç»­å¤„ç†å‰©ä½™æ–‡ä»¶ |

> ğŸ›¡ï¸ **è®¾è®¡åŸåˆ™**ï¼š**â€œç³»ç»Ÿåº”å®¹å¿å±€éƒ¨å¤±è´¥ï¼Œè€Œéå› å•ç‚¹æ•…éšœè€Œå´©æºƒâ€**ã€‚æ‰€æœ‰é”™è¯¯å‡è¢«è®°å½•åœ¨ `ProcessResult` çš„ `errors` å­—æ®µä¸­ï¼Œä¾›æ—¥å¿—æˆ– CI æŠ¥å‘Šåˆ†æã€‚

---

## **8. å¯æµ‹è¯•æ€§è®¾è®¡**

å¤„ç†åè°ƒåŸŸæ˜¯**å•å…ƒæµ‹è¯•å‹å¥½å‹**æ¨¡å—ï¼Œæ”¯æŒä»¥ä¸‹æµ‹è¯•æ¨¡å¼ï¼š

| æµ‹è¯•ç±»å‹ | å®ç°æ–¹å¼ |
|----------|----------|
| **å•å…ƒæµ‹è¯•** | æ³¨å…¥ Mock Scanner/Validator/AiFixerï¼ŒéªŒè¯æµç¨‹é€»è¾‘æ˜¯å¦æŒ‰é¢„æœŸè°ƒç”¨ |
| **é›†æˆæµ‹è¯•** | ä½¿ç”¨çœŸå®æ–‡ä»¶ç³»ç»Ÿ + æ¨¡æ‹Ÿ LLM å“åº”ï¼ˆå¦‚ `mockito`ï¼‰ï¼ŒéªŒè¯ç«¯åˆ°ç«¯è¡Œä¸º |
| **é…ç½®é©±åŠ¨æµ‹è¯•** | é€šè¿‡ä¸åŒ `Config` å®ä¾‹ï¼ˆ`dry_run=true/false`, `enable_ai_repair=false`ï¼‰éªŒè¯è¡Œä¸ºå·®å¼‚ |

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use mockall::mock;

    mock! {
        pub Scanner {}
        impl MarkdownScanner for Scanner {
            async fn scan_directory(&self, dir: &Path) -> Result<Vec<PathBuf>, Error>;
        }
    }

    #[tokio::test]
    async fn test_process_directory_dry_run() {
        let mut scanner = MockScanner::new();
        scanner.expect_scan_directory().returning(|_| Ok(vec![PathBuf::from("test.md")]));

        let mut validator = MockValidator::new();
        validator.expect_validate().returning(|_| Err(ValidationError::Syntax));

        let processor = MermaidProcessor::new(&scanner, &validator, None, &config_dry_run);

        let result = processor.process_directory(&Path::new("/tmp")).await.unwrap();
        assert_eq!(result.repaired_blocks, 0); // å¹²è¿è¡Œï¼Œä¸ä¿®å¤
        assert_eq!(result.written_files, 0);   // ä¸å†™å›
    }
}
```

> âœ… **æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡**ï¼šå¤„ç†åè°ƒåŸŸçš„é€»è¾‘åˆ†æ”¯ï¼ˆå¦‚ `dry_run`ã€`ai_fixer` æ˜¯å¦å¯ç”¨ï¼‰åº”è¾¾åˆ° **100% è¦†ç›–**ã€‚

---

## **9. æ‰©å±•æ€§ä¸æœªæ¥æ¼”è¿›**

å¤„ç†åè°ƒåŸŸçš„è®¾è®¡å¤©ç„¶æ”¯æŒä»¥ä¸‹æ‰©å±•ï¼š

| æ‰©å±•æ–¹å‘ | å®ç°æ–¹å¼ |
|----------|----------|
| **æ”¯æŒå¤šè¯­è¨€å›¾è¡¨** | æ–°å¢ `CodeBlockValidator` traitï¼Œæ‰©å±•æ”¯æŒ PlantUMLã€Graphvizï¼Œç”±é…ç½®åŠ¨æ€æ³¨å†Œ |
| **æ”¯æŒå¤š AI æ¨¡å‹** | å®ç° `AiFixer` trait çš„å¤šä¸ªå®ç°ï¼ˆOpenAIã€Claudeã€æœ¬åœ° Ollamaï¼‰ï¼Œé€šè¿‡é…ç½®åˆ‡æ¢ |
| **æ”¯æŒä¿®å¤åæ ¼å¼åŒ–** | åœ¨å†™å›å‰æ’å…¥ `CodeFormatter` æ¨¡å—ï¼Œè‡ªåŠ¨ç¼©è¿›ã€å¯¹é½ Mermaid ä»£ç  |
| **æ”¯æŒå¹¶è¡Œå¤„ç†** | å°† `process_single_file` æ”¹ä¸º `join_all` å¹¶è¡Œæ‰§è¡Œï¼Œæå‡ååé‡ |
| **æ”¯æŒä¿®å¤å»ºè®®è¾“å‡º** | æ–°å¢ `--output-suggestions` æ¨¡å¼ï¼Œå°†ä¿®å¤å»ºè®®å†™å…¥ `.fixes.json`ï¼Œä¸ä¿®æ”¹åŸæ–‡ä»¶ |

> ğŸ”® **æ¶æ„ä¼˜åŠ¿**ï¼šç”±äºæ‰€æœ‰å­æ¨¡å—é€šè¿‡æ¥å£ï¼ˆtraitï¼‰äº¤äº’ï¼Œæ–°å¢åŠŸèƒ½æ— éœ€ä¿®æ”¹ `processor.rs`ï¼Œåªéœ€å®ç°æ–°æ¨¡å—å¹¶æ³¨å…¥å³å¯ã€‚

---

## **10. æ€»ç»“ï¼šä¸ºä»€ä¹ˆå¤„ç†åè°ƒåŸŸæ˜¯ç³»ç»Ÿçš„å…³é”®**

| ç»´åº¦ | ä»·å€¼ä½“ç° |
|------|----------|
| **æ¶æ„æ¸…æ™°æ€§** | æ˜ç¡®åˆ’åˆ†â€œæ§åˆ¶â€ä¸â€œå®ç°â€ï¼Œé¿å…é€»è¾‘æ··æ‚ï¼Œæå‡å¯ç»´æŠ¤æ€§ |
| **ç¨³å®šæ€§ä¿éšœ** | å®¹é”™è®¾è®¡ç¡®ä¿â€œéƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“â€ï¼Œé€‚åˆ CI/CD ç¯å¢ƒ |
| **å¯é…ç½®æ€§** | æ‰€æœ‰è¡Œä¸ºç”±é…ç½®é©±åŠ¨ï¼Œæ”¯æŒâ€œä¸€é”®åˆ‡æ¢â€ä¿®å¤æ¨¡å¼ |
| **å¯æµ‹è¯•æ€§** | æ¨¡å—è§£è€¦ + ä¾èµ–æ³¨å…¥ï¼Œå®ç°é«˜è¦†ç›–ç‡è‡ªåŠ¨åŒ–æµ‹è¯• |
| **æ€§èƒ½ä¼˜åŒ–** | å¼‚æ­¥æ¨¡å‹æ˜¾è‘—æå‡å¤§è§„æ¨¡æ–‡æ¡£å¤„ç†æ•ˆç‡ |
| **æ‰©å±•æ½œåŠ›** | å¼€é—­åŸåˆ™æ”¯æŒæœªæ¥æ–°å¢å›¾è¡¨ç±»å‹ã€ä¿®å¤å¼•æ“ã€è¾“å‡ºæ ¼å¼ |

> âœ… **æœ€ç»ˆç»“è®º**ï¼š  
> **å¤„ç†åè°ƒåŸŸä¸æ˜¯æœ€å¤æ‚çš„æ¨¡å—ï¼Œä½†å®ƒæ˜¯ç³»ç»Ÿæœ€æ ¸å¿ƒçš„â€œç¥ç»ç³»ç»Ÿâ€**ã€‚å®ƒå†³å®šäº†è‡ªåŠ¨åŒ–æµç¨‹æ˜¯å¦å¯é ã€é«˜æ•ˆã€å¯æ§ã€‚å…¶è®¾è®¡è´¨é‡ç›´æ¥å†³å®šäº† `mermaid-fixer` æ˜¯å¦èƒ½ä»â€œä¸€ä¸ªå·¥å…·â€æˆé•¿ä¸ºâ€œä¼ä¸šçº§æ–‡æ¡£è´¨é‡ä¿éšœåŸºç¡€è®¾æ–½â€ã€‚

---

## **é™„å½•ï¼šå…³é”®ä»£ç æ–‡ä»¶**

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `src/processor.rs` | æ ¸å¿ƒå®ç°ï¼ŒåŒ…å« `MermaidProcessor` ç»“æ„ä½“ä¸ `process_directory` æ–¹æ³• |
| `src/processor/mod.rs` | æ¨¡å—å¯¼å‡ºä¸å…¬å…±æ¥å£å®šä¹‰ |
| `src/processor/error.rs` | è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼ˆ`ProcessorError`ï¼‰ |
| `src/processor/result.rs` | `ProcessResult` ä¸ `FileProcessResult` å®šä¹‰ |
| `tests/processor.rs` | å•å…ƒä¸é›†æˆæµ‹è¯•ç”¨ä¾‹ |

---

> ğŸ“Œ **æ¨èå®è·µ**ï¼š  
> åœ¨ CI/CD æµç¨‹ä¸­ï¼Œå»ºè®®å°† `mermaid-fixer` çš„ `--dry-run` æ¨¡å¼ä½œä¸ºâ€œæ–‡æ¡£è´¨é‡é—¨ç¦â€ï¼ˆQuality Gateï¼‰ï¼Œè‹¥æ£€æµ‹åˆ°æ— æ•ˆå—åˆ™å¤±è´¥æ„å»ºï¼Œå¼ºåˆ¶ä¿®å¤åå†åˆå¹¶ã€‚å¤„ç†åè°ƒåŸŸæ­£æ˜¯å®ç°è¿™ä¸€ç­–ç•¥çš„**æŠ€æœ¯åŸºçŸ³**ã€‚